{% extends "layout.html" %}
{% block content %}
<div class="header-row" style="display: flex; align-items: center; justify-content: space-between;">
    <h2 style="margin: 0;">Storage Bins</h2>
    <form method="get" action="{{ url_for('main.index') }}" style="display: flex; gap: 8px;">
        <input type="text" name="q" placeholder="Search bins..." value="{{ request.args.get('q', '') }}">
        <button type="submit"><i class="fa fa-search"></i> Search</button>
    </form>
</div>

<!-- Add Bin Form: single row -->
<form method="post" action="{{ url_for('bin.add_bin') }}" style="display: flex; gap: 8px; margin: 16px 0;">
    <label for="name">Bin Name</label>
    <input type="text" id="name" name="name" placeholder="Bin Name" required>
    <label for="location">Location</label>
    <input type="text" id="location" name="location" placeholder="Location" required>
    <label for="notes">Notes</label>
    <input type="text" id="notes" name="notes" placeholder="Notes">
    <button type="submit"><i class="fa fa-plus"></i> Add Bin</button>
</form>

<form id="bulk-bin-form" method="post" action="{{ url_for('bin.bulk_action') }}">
    <div style="margin-bottom: 8px;">
        <input type="checkbox" id="select-all-bins" onclick="toggleAllBins(this)">
        <label for="select-all-bins">Select All</label>
        <button type="submit" name="action" value="delete" onclick="return confirm('Are you sure you want to delete the selected bins?');">
            <i class="fa fa-trash"></i> Delete Selected
        </button>
        <button type="submit" name="action" value="move">
            <i class="fa fa-arrow-right"></i> Move Selected
        </button>
        <select name="new_location" style="margin-left:8px;">
            <option value="">-- Move to Location --</option>
            <option value="Garage">Garage</option>
            <option value="Attic">Attic</option>
            <!-- Add more locations as needed -->
        </select>
    </div>
    <ul>
        {% for bin in bins %}
        <li style="position: relative;">
            <input type="checkbox" name="bin_ids" value="{{ bin.id }}" class="bin-checkbox">
            <a href="{{ url_for('bin.bin_detail', bin_id=bin.id) }}">{{ bin.name }}</a>
            ({{ bin.location }})
            {% if bin.notes %}
                - <span class="bin-notes">{{ bin.notes }}</span>
            {% endif %}
            {% if bin.qr_code_filename %}
                <span class="qr-hover-container" style="position: relative; display: inline-block;">
                    <img src="{{ url_for('static', filename='qrcodes/' ~ bin.qr_code_filename) }}"
                        alt="QR code for {{ bin.name }}"
                        style="height:120px; cursor:pointer;"
                        onmouseenter="showScanner({{ bin.id }})"
                        onmouseleave="hideScannerDelayed({{ bin.id }})">
                    <div id="scanner-{{ bin.id }}" class="qr-scanner-popup"
                        style="display:none; position:absolute; top:45px; left:0; background:#fff; border:1px solid #ccc; z-index:10;"
                        onmouseenter="showScanner({{ bin.id }})"
                        onmouseleave="hideScannerDelayed({{ bin.id }})">
                        <div id="reader-{{ bin.id }}" style="width:200px; height:200px;"></div>
                    </div>
                </span>
                <!-- Delete button to the right of the QR code -->
                <form method="post" action="{{ url_for('bin.delete_bin', bin_id=bin.id) }}" style="display:inline; margin-left: 12px;" onsubmit="return confirm('Are you sure you want to delete this bin?');">
                    <button type="submit" title="Delete Bin" aria-label="Delete {{ bin.name }}" style="background:none; border:none; color:#c0392b; cursor:pointer;">
                        <i class="fa fa-trash"></i>
                    </button>
                </form>
            {% endif %}
        </li>
        {% endfor %}
    </ul>
</form>

<script src="{{ url_for('static', filename='html5-qrcode.min.js') }}"></script>
<script>
let scanners = {};
let hideTimeouts = {};

function showScanner(binId) {
    clearTimeout(hideTimeouts[binId]);
    const popup = document.getElementById('scanner-' + binId);
    popup.style.display = 'block';
    document.getElementById('reader-' + binId).innerHTML = '';
    scanners[binId] = new Html5QrcodeScanner(
        "reader-" + binId, { fps: 10, qrbox: 150 });
    scanners[binId].render(function(decodedText, decodedResult) {
        window.location.href = "/bin/" + decodedText;
    });
}

function hideScanner(binId) {
    const popup = document.getElementById('scanner-' + binId);
    popup.style.display = 'none';
    document.getElementById('reader-' + binId).innerHTML = '';
    scanners[binId] = null;
}

function hideScannerDelayed(binId) {
    hideTimeouts[binId] = setTimeout(function() {
        hideScanner(binId);
    }, 200); // 200ms delay to allow moving between image and popup
}

function toggleAllBins(source) {
    const checkboxes = document.querySelectorAll('.bin-checkbox');
    for (const cb of checkboxes) {
        cb.checked = source.checked;
    }
}
</script>

<div class="pagination">
    {% if pagination.has_prev %}
        <a href="{{ url_for('main.index', page=pagination.prev_num, q=request.args.get('q', '')) }}">&laquo; Prev</a>
    {% endif %}
    <span>Page {{ pagination.page }} of {{ pagination.pages }}</span>
    {% if pagination.has_next %}
        <a href="{{ url_for('main.index', page=pagination.next_num, q=request.args.get('q', '')) }}">Next &raquo;</a>
    {% endif %}
</div>
{% endblock %}